# 救急搬送支援システム 設計書（MVP）

作成日: 2026-02-20  
対象: Next.js(App Router) / Prisma / Neon(PostgreSQL) / Vercel

## 1. 目的
- A側中心MVPを最短で稼働させる。
- 入力速度を重視しつつ、将来のHP側拡張に耐えるデータモデルを先に固定する。
- 同一概念の重複保持を避け、双方向反映をDBレベルで破綻しない形にする。

## 2. 全体アーキテクチャ
- 単一モノリス構成: Next.js + Route Handlers + Prisma。
- ルーティングはA側/HP側を分離（例: `app/(ems)` と `app/(hospital)`）。
- MVPでは認証なし。ただしHP側の将来制約を見据えて `hospital_id` スコープ前提の設計を維持する。
- 病院検索の「直近順」は暫定で `三鷹市下連雀1-1-1` 基準の直線距離ソートを採用する。

## 3. 画面スコープ（MVP）
- Aホーム
- 救急事案入力（個人情報/状況/詳細情報/基本所見/脳卒中/CCU/外傷）
- 病院検索・搬送先選択
- 選定履歴
- 書類閲覧（MVPはプレースホルダ）
- 指令情報（モーダル）
- HP側は将来拡張用に最小プレースホルダのみ配置

## 4. データ設計方針
- `cases` を中心に `started_at`, `ended_at`, `purge_at` を保持。
- バイタルは `case_vitals` に時系列保持し、`sequence` は1..5、`case_id + sequence` をユニーク制約化。
- 2回目以降のバイタルコピー運用を追跡するため `copied_from_vital_id` を保持。
- 同一概念の単一データ化:
  - 胸痛: 基本所見（循環器）とCCUは同一ソースを編集
  - 麻痺: 基本所見（神経）と脳卒中は同一ソースを編集
- 別概念は分離:
  - 神経随伴の嘔吐と消化器の嘔吐は別テーブル/別カラム運用
- 病院要請は固定列挙ステータスで実装し、`request_messages` で要相談時ログを保持。

## 5. 検索・選定ロジック（MVP）
- 絞り込み: 地域（区市/県）、病院名部分一致、診療科目、AND/OR。
- 診療科グルーピング:
  - 内科選択時に内科系サブ科を展開対象へ追加
  - 外科選択時に外科系サブ科を展開対象へ追加
- 並び順: 基準点からの距離昇順。

## 6. バリデーションと整合性
- 必須: 氏名（不明可）、生年月日（不明可）、年齢（必須入力）、性別、JCS。
- JCS>=10時は意識障害所見を自動ONし、JCS/GCSを正本扱いにする。
- `case_vitals` は最大5件をAPI/DBの両面で制限。
- ステータス遷移は許可フローを明示し、不正遷移を409で返す。

## 7. 保存期間・運用
- `ended_at` 設定時に `purge_at=ended_at+30日` を設定。
- 初期は論理削除（一覧表示から除外）を採用。物理削除は後続で検討。

## 8. 初期データ
- 病院マスタ自動生成:
  - 東京: 100件
  - 神奈川/埼玉/千葉: 各10件
- 住所/座標/診療科を含む検索可能データとして投入。

## 9. 品質保証
- 単体: 科目AND/OR、グルーピング、JCS連動ロジック。
- 結合: 事案作成、バイタルコピー、要請ステータス遷移、メッセージ送受信。
- E2E: A側の主導線（事案作成→病院検索→要請→搬送決定）。
